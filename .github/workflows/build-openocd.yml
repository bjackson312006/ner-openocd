# .github/workflows/build-openocd.yml
name: Build OpenOCD for All Platforms

on:
  workflow_dispatch:
  push:
    tags:
      - 'tools-v*'

# so it can make releases
permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool \
            pkg-config libusb-1.0-0-dev libhidapi-dev texinfo rpm alien
      
      - name: Checkout ST OpenOCD
        uses: actions/checkout@v4
        with:
          repository: STMicroelectronics/OpenOCD
          ref: openocd-cubeide-r6
      
      - name: Clean up any stale git locks
        run: |
          rm -f .git/index.lock
      
      - name: Build
        run: |
          ./bootstrap
          ./configure --prefix=/usr --disable-werror
          make -j$(nproc)
          make DESTDIR=$PWD/dist install
      
      - name: Create tarball
        run: |
          cd dist
          tar czf ../openocd-stm32-linux-x64.tar.gz usr/
      
      - name: Create RPM package
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # Create RPM spec file
          cat > rpmbuild/SPECS/openocd-stm32.spec <<'EOF'
          Name:           openocd-stm32
          Version:        0.12.0
          Release:        1%{?dist}
          Summary:        STMicroelectronics fork of OpenOCD
          License:        GPLv2+
          URL:            https://github.com/STMicroelectronics/OpenOCD
          
          Requires:       libusb hidapi
          
          %description
          OpenOCD - Open On-Chip Debugger
          STMicroelectronics customized version with enhanced STM32 support.
          
          %install
          cp -a %{_sourcedir}/dist/usr %{buildroot}/
          
          %files
          /usr/bin/openocd
          /usr/share/openocd/
          /usr/share/info/*
          /usr/share/man/man1/openocd.1*
          EOF
          
          cp -r dist rpmbuild/SOURCES/
          rpmbuild --define "_topdir $PWD/rpmbuild" -bb rpmbuild/SPECS/openocd-stm32.spec
      
      - name: Convert RPM to DEB using alien
        run: |
          sudo alien -d -k rpmbuild/RPMS/x86_64/*.rpm
          mv openocd-stm32_*.deb openocd-stm32-linux-x64.deb
      
      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: openocd-stm32-linux-x64-tar
          path: openocd-stm32-linux-x64.tar.gz
      
      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: openocd-stm32-linux-x64-deb
          path: openocd-stm32-linux-x64.deb

  build-macos-x64:
    runs-on: macos-15-intel  # macos-13 got depriciated
    steps:
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config libusb hidapi texinfo
      
      - name: Checkout ST OpenOCD
        uses: actions/checkout@v4
        with:
          repository: STMicroelectronics/OpenOCD
          ref: openocd-cubeide-r6
      
      - name: Clean up any stale git locks
        run: |
          rm -f .git/index.lock
      
      - name: Build
        run: |
          ./bootstrap
          ./configure --prefix=/usr/local --disable-werror
          make -j$(sysctl -n hw.ncpu)
          make DESTDIR=$PWD/dist install
      
      - name: Create tarball
        run: |
          cd dist
          tar czf ../openocd-stm32-macos-x64.tar.gz usr/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openocd-stm32-macos-x64
          path: openocd-stm32-macos-x64.tar.gz

  build-macos-arm64:
    runs-on: macos-14  # Apple Silicon Mac
    steps:
      - name: Install dependencies
        run: |
          brew install autoconf automake libtool pkg-config libusb hidapi texinfo
      
      - name: Checkout ST OpenOCD
        uses: actions/checkout@v4
        with:
          repository: STMicroelectronics/OpenOCD
          ref: openocd-cubeide-r6
      
      - name: Clean up any stale git locks
        run: |
          rm -f .git/index.lock
      
      - name: Build
        run: |
          ./bootstrap
          ./configure --prefix=/usr/local --disable-werror
          make -j$(sysctl -n hw.ncpu)
          make DESTDIR=$PWD/dist install
      
      - name: Create tarball
        run: |
          cd dist
          tar czf ../openocd-stm32-macos-arm64.tar.gz usr/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openocd-stm32-macos-arm64
          path: openocd-stm32-macos-arm64.tar.gz

  # build-windows:
  #   runs-on: windows-latest
  #   defaults:
  #     run:
  #       shell: msys2 {0}
  #   steps:
  #     - name: Setup MSYS2
  #       uses: msys2/setup-msys2@v2
  #       with:
  #         msystem: MINGW64
  #         update: true
  #         install: >-
  #           git
  #           base-devel
  #           mingw-w64-x86_64-toolchain
  #           mingw-w64-x86_64-autotools
  #           mingw-w64-x86_64-libusb
  #           mingw-w64-x86_64-hidapi
  #           texinfo
  #           tar
      
  #     - name: Checkout ST OpenOCD
  #       uses: actions/checkout@v4
  #       with:
  #         repository: STMicroelectronics/OpenOCD
  #         ref: openocd-cubeide-r6
      
  #     - name: Clean up any stale git locks
  #       run: |
  #         rm -f .git/index.lock
      
  #     - name: Build
  #       run: |
  #         ./bootstrap
  #         ./configure --prefix=/mingw64 --disable-werror
  #         make -j$(nproc)
  #         make DESTDIR=$PWD/dist install
      
  #     - name: Create zip archive
  #       run: |
  #         cd dist
  #         tar czf ../openocd-stm32-windows-x64.tar.gz mingw64/
      
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: openocd-stm32-windows-x64
  #         path: openocd-stm32-windows-x64.tar.gz

  create-release:
    needs: [build-linux, build-macos-x64, build-macos-arm64] # technically we dont need windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/tools-v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/openocd-stm32-linux-x64-tar/openocd-stm32-linux-x64.tar.gz
            artifacts/openocd-stm32-linux-x64-deb/openocd-stm32-linux-x64.deb
            artifacts/openocd-stm32-macos-x64/openocd-stm32-macos-x64.tar.gz
            artifacts/openocd-stm32-macos-arm64/openocd-stm32-macos-arm64.tar.gz
          draft: false
          prerelease: false
